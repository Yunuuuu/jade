{
    "version": "4.2.1",
    "description": "R with MKL",
    "homepage": "https://www.r-project.org",
    "license": "GPL-2.0-only",
    "notes": [
        "The base R BLAS and LAPACK have been replaced by Intel's Math Kernel Library (MKL) existing in MRO.",
        "",
        "For source packages installation, please install 'rtools'.",
        "",
        "You'll need to type 'r.ps1' or 'r.cmd' to run R, because in Powershell 'r' runs the last command. Alternatively 'rterm' can be used to start the interactive R terminal session.",
        "",
        "You can remove Powershell's 'r' command with:",
        "    rm alias:\\r",
        "",
        "... but this only affects your current session: if you'd like to remove it for all future sessions you need to add the command above to your Powershell profile.",
        "",
        "Annoying, right?! You might want to check out Pshazz (scoop install pshazz)--this has a plugin to remove some crazy aliases from Powershell, as well as many other improvements."
    ],
    "url": "https://cran.r-project.org/bin/windows/base/old/4.2.1/R-4.2.1-win.exe",
    "hash": "md5:fde08d4607dd6cef6768bb18999360ad",
    "innosetup": true,
    "architecture": {
        "64bit": {
            "pre_install": [
                "$version_cur = [Version]\"$version\"",
                "$version_42 = [Version]\"4.2.0\"",
                "$check_version = $version_cur -ge $version_42",
                "if (-not $check_version) {",
                "   Rename-Item \"$dir\\bin\\R,2.exe\" 'R.exe'",
                "}"
            ],
            "bin": [
                "bin\\x64\\R.exe",
                "bin\\x64\\Rcmd.exe",
                "bin\\x64\\Rgui.exe",
                "bin\\x64\\Rscript.exe",
                "bin\\x64\\Rterm.exe"
            ],
            "shortcuts": [
                [
                    "bin\\x64\\Rgui.exe",
                    "R"
                ]
            ]
        },
        "32bit": {
            "pre_install": [
                "$version_cur = [Version]\"$version\"",
                "$version_42 = [Version]\"4.2.0\"",
                "$check_version = $version_cur -ge $version_42",
                "if (-not $check_version) {",
                "   Rename-Item \"$dir\\bin\\R,1.exe\" 'R.exe'",
                "}"
            ],
            "bin": [
                "bin\\i386\\R.exe",
                "bin\\i386\\Rcmd.exe",
                "bin\\i386\\Rgui.exe",
                "bin\\i386\\Rscript.exe",
                "bin\\i386\\Rterm.exe"
            ],
            "shortcuts": [
                [
                    "bin\\i386\\Rgui.exe",
                    "R"
                ]
            ]
        }
    },
    "installer": {
        "script": [
            "$version_cur = [Version]\"$version\"",
            "$version_42 = [Version]\"4.2.0\"",
            "$check_version = $version_cur -ge $version_42",
            "if (-not $check_version) {",
            "   Remove-Item \"$dir\\bin\\R,*.exe\" -Force",
            "}",
            "Copy-Item \"$dir\\bin\\R.exe\" \"$dir\\bin\\Rscript.exe\"",
            "$mkl_path = \"$bucketsdir\\jade\\config\\mro\"",
            "function BackUp([String] $file) {",
            "   if (-not (Test-Path -Path \"$dir\\bin\\x64\\$file.bak\")) {",
            "       Write-Host \"Backup $file\"",
            "       Copy-Item \"$dir\\bin\\x64\\$file\" -Destination \"$dir\\bin\\x64\\$file.bak\"",
            "   }",
            "}",
            "BackUp 'Rblas.dll'",
            "BackUp 'Rlapack.dll'",
            "function InstallFile([String] $file) {",
            "    Write-Host \"Installing $file\"",
            "    Copy-Item \"$mkl_path\\4.0.2\\$file\" -Destination \"$dir\\bin\\x64\\$file\" -Force ",
            "}",
            "InstallFile 'libiomp5md.dll'",
            "InstallFile 'Rblas.dll'",
            "InstallFile 'Rlapack.dll'",
            "Expand-Archive -Path \"$mkl_path\\mro_pkgs.zip\" -DestinationPath \"$dir\\library\" -Force"
        ]
    },
    "post_install": [
        "$version_cur = [Version]\"$version\"",
        "$version_42 = [Version]\"4.2.0\"",
        "$version_40 = [Version]\"4.0.0\"",
        "if (($version_cur -lt $version_42) -and ($version_cur -ge $version_40)) {",
        "   $pathenv = 'PATH=\"${RTOOLS40_HOME}/usr/bin;${PATH}\"'",
        "   [IO.File]::WriteAllLines(\"$dir\\etc\\Renviron.site\", $pathenv)",
        "}",
        "if ($version_cur -lt $version_40) {",
        "   $ruserenv = 'R_USER=\"${USERPROFILE}/Documents\"'",
        "   [IO.File]::WriteAllLines(\"$dir\\etc\\Renviron.site\", $ruserenv)",
        "}",
        "$message_rmkl = ' ",
        " ",
        "if (suppressMessages(requireNamespace(\"RevoUtilsMath\"))) {",
        "    cat(paste(",
        "        \"Using the Intel MKL for parallel mathematical computing (using\",",
        "        RevoUtilsMath::getMKLthreads(), \"cores).\\n\", ",
        "        sep = \" \"",
        "    ))",
        "}'",
        "[IO.File]::AppendAllText(\"$dir\\etc\\Rprofile.site\", $message_rmkl)",
        "& \"$bucketsdir\\jade\\scripts\\keep_extra_persist.ps1\" \"${env:LOCALAPPDATA}\\R\" -name \"Local\\R\""
    ],
    "uninstaller": {
        "script": [
            "function remove_link($dir) {",
            "    write-host \"Unlinking $dir\"",
            "    $source = (Get-Item -Path $dir -Force)",
            "    if ($source.LinkType) {",
            "        $source_path = $source.FullName",
            "        # directory (junction)",
            "        if ($source -is [System.IO.DirectoryInfo]) {",
            "            # remove read-only attribute on the link",
            "            attrib -R /L $source_path",
            "            # remove the junction",
            "            Remove-Item -Path $source_path -Recurse -Force -ErrorAction SilentlyContinue",
            "        } else {",
            "            # remove the hard link",
            "            Remove-Item -Path $source_path -Force -ErrorAction SilentlyContinue",
            "        }",
            "    }",
            "}",
            "remove_link \"${env:LOCALAPPDATA}\\R\""
        ]
    },
    "checkver": {
        "url": "https://cran.r-project.org/bin/windows/base/",
        "regex": "R-([\\d.]+)"
    },
    "autoupdate": {
        "url": "https://cran.r-project.org/bin/windows/base/old/$version/R-$version-win.exe",
        "hash": {
            "url": "https://cran.r-project.org/bin/windows/base/old/$version/md5sum.R-$version.txt"
        }
    }
}
